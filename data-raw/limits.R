library(wqbc)
library(dplyr)

check_limits <- function (x) {

  check_valid_expression <- function (x) {
    parse(text = x)
    TRUE
  }

  stopifnot(identical(colnames(x),
                      c("Variable", "Average",
                        "Condition", "LowerLimit", "UpperLimit", "Units", "Table",
                        "Reference", "Use")))

  stopifnot(all(!is.na(x$Variable)))
  stopifnot(all(!is.na(x$LowerLimit) | !is.na(x$UpperLimit)))
  stopifnot(all(!is.na(x$Units)))
  stopifnot(all(!is.na(x$Table)))
  stopifnot(all(!is.na(x$Reference)))
  stopifnot(all(!is.na(x$Use)))

  stopifnot(all(x$Units %in% get_units()))
  stopifnot(all(x$Reference %in% c("BC_2006", "EMAIL_2014")))
  stopifnot(all(x$Use %in% c("Freshwater Life")))

  check_valid_expression(x$Condition)
  check_valid_expression(x$LowerLimit)
  check_valid_expression(x$UpperLimit)

  TRUE
}

input_limits <- function () {

  load("data/codes.rda")
  limits <- read.csv("data-raw/limits.csv", na.strings = c("NA", ""), stringsAsFactors = FALSE)

  check_limits(limits)

  # lapply(limits, FUN = function (limits) (sort(unique(limits))))
  #   write.csv(limits, "data-raw/limits.csv", row.names = FALSE)

  limits <- rename_(limits, "..Units" = "Units")

  n <- nrow(limits)
  limits <- left_join(limits, codes, by = "Variable")
  stopifnot(n == nrow(limits))

  stopifnot(all(limits$..Units == limits$Units))
  limits$..Unit <- NULL

  limits %<>% dplyr::filter(
    !is.na(Variable) &
      !is.na(Code) &
      !(is.na(LowerLimit) & is.na(UpperLimit)) &
      !is.na(Units))

  limits %<>% arrange(Variable, Average)

  limits %<>% select(Variable, Code,
                     Average, Condition, LowerLimit, UpperLimit, Units)

  limits$Code %<>% factor
  limits$Average %<>% factor
  limits$Variable %<>% factor
  limits$Units %<>% droplevels

  limits
}
limits <- input_limits()
devtools::use_data(limits, overwrite = TRUE, compress = "xz")
