---
title: "wqbc: Water Quality Thresholds and Indices for British Columbia"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{wqbc}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r, echo = FALSE, message = FALSE}
library(wqbc)
library(lubridate)
library(xtable)
library(tidyr)
library(dplyr)
knitr::opts_chunk$set(
  comment = "#>",
  error = FALSE,
  tidy = FALSE)
```

# Introduction


The main function of the `wqbc` (water quality for Brittish Columbia) package is to calculate the Canadian Council of Ministers of the Environment (CCME) water quality index (WQI) for water bodies in Brittish Columbia, the procedure is set out in the CCME WQI (1.0) [User's Manual](http://www.ccme.ca/files/Resources/calculators/WQI%20User%27s%20Manual%20%28en%29.pdf "download pdf").  

the `wqbc` package provides several functions, the two most important being`calc_limits` and `plot_map`. Water quality indices are calculated through the function `calc_limits`.  For the visual display of the calculated water quality indices over a map of British Columbia, the function `plot_map` is provided.

The purpose of this document is to provide some background to the calculation of indices, provide worked examples of the calculation of indices and and to show how various summaries of the indices can be displayed visually.  In addition there are also some examples of more advanced methods to calculate confidence intervals for water quality indices, using code from within the package, but also from an additional pacakage YY.

The data used in the examples are from the fraser river basin and an example taken from the CCME WQI [User's Manual](http://www.ccme.ca/files/Resources/calculators/WQI%20User%27s%20Manual%20%28en%29.pdf "download pdf").  Additional data is available from a sister package `wqbc-data`.  This package is to serve as a repository for a number of datasets on water quality monitoring in Brittish Columbia.

The following methods of analysing water quality are provided:

1. Calculation of the CCME water qualty index
%2. Exceedance analysis based on appropriate guidline threshold values
%3. Trend tests for individual parameters
4. Methods for visualisation of water quality

The package is intended to be easy to use and provide a flexible means for the exploration of water quality monitoring data. The document is split into the following sections:

* [The CCME Example]
* [The CCME Water Quality Index (1.0)]
* [Data format] 
* [Water quality index calculation]
* [Visual display of indices] 
* [Advanced examples]





<!--
____________________________________________________

               Easy Example Section
____________________________________________________

-->

# The CCME Example

Lets begin with an example understand how the water quality index works. To begin the package is loaded into R using

```{r}
library(wqbc)
```

to demonstrate the utility of the package a good example dataset is that tabled in the CCME WQI (1.0) [User's Manual](http://www.ccme.ca/files/Resources/calculators/WQI%20User%27s%20Manual%20%28en%29.pdf "download pdf"), which uses a simplified data set from the North Saskatchewan River at Devon, Alberta. A table of the data is given below

```{r ccmedata, echo=FALSE, results='asis'}
library(xtable)
data(ccme)
tab <- spread(select(ccme, Variable, Value, Date), Variable, Value)
tab $ Date <- as.character(tab $ Date)
# Analysis of variance.
print(xtable(tab), type = "html")
```

This data is shipped with the wqbc package and has been called `ccme`.  To load the `ccme` data into the R session run

```{r}
data(ccme)
```
The first 12 rows of the data contain all the data for Disolved Oxygen (DO) as shown here

```{r}
head(ccme, 12)
```

Not only are the observed water chemistry values, there is auxilliary information on the analysis methods used, i.e. the detection limits, and lower and upper limits; and the units of measurement.  The water quality index based on all this data is calculated using the command

```{r, echo = 2}
options(wqbc.messages = FALSE)
calc_wqi(ccme)
options(wqbc.messages = TRUE)
```

Giving the result 88.1, and given the categories defined in the CCME WQI this equates to a score of 'GOOD'.  The `calc_wqi` function gives some additional information.  The values for each component of the index are given, so, F1 = 20, F2 = 3.9, and F3 = 2.8.  We are also told that there were 10 variables included in the index, which allows us to interpret F1=20 as there being 2 variables which did not meet objectives, however, the proportion of tests not meeting objectives (F2) and the excursions were small (F3) so that these failures are not considered to be a concern.  In order to assess the certainty of the calsification, confidence intervals are provided for the overall WQI.  In this case, both confidence intervals lie within the definition of 'good'.





<!--
____________________________________________________

     An overview of the index definition
____________________________________________________

-->


# The CCME Water Quality Index (1.0)

Water quality is assessed by the monitoring of a range of quantites known as _parameters_.  The majority of water quality parameters are concentrations of various chemicals, however, quantities such as water turbidity and pH are also important.  Comprehensive water quality monitoring has been undertaken in the Fraser RIver Basin (BC, Canada) since 1979, and this data is provided in the package, however the tools in this package can be applied to any suitable data set provided it meets specific restrictions detailed in the [Data format] section.

The CCME Water Quality Index (1.0) is based on a combination of three factors:

* [Scope] the number of variables whose objectives are not met,
* [Frequency] the frequency with which the objectives are not met, and
* [Amplitude] the amount by which the objectives are not met.

These are combined to produce a single value (between 0 and 100) that is intended to describe overall water quality.   In the [Water quality index calculation] section you can see examples of the CCME WQI in action.





<!--
____________________________________________________

     Something on data?  Might put this to the end
____________________________________________________

-->


# Data format

There are two datasets provided with the package which follow the data format required by the index calculation routines:

* [ccme] This dataset contains the CCME (Canadian Council of Ministers of the Environment) Water Quality Index 1.0 [User's Manual](http://www.ccme.ca/files/Resources/calculators/WQI%20User%27s%20Manual%20%28en%29.pdf "download pdf") example dataset.  The data is a timeseries of water chemistry measurements taken from North Saskatchewan river at Devon throughout 1997.

* [fraser] This dataset contains long term surface freshwater quality monitoring data from the Fraser River Basin (the data was extracted from [here](http://open.canada.ca/data/en/dataset/9ec91c92-22f8-4520-8b2c-0f1cce663e18 "data")) carried out under the Canada-British Columbia Water Quality Monitoring Agreement. Water quality monitoring is conducted to assess water quality status and long-term trends, detect emerging issues, establish water quality guidelines and track the effectiveness of remedial measures and regulatory decisions

    The original dataset has been filtered to remove values for variables without currently defined limits. In addition, variables are referenced by code, unimportant columns have been dropped and the remaining columns renamed.

Specifically the data format is: ...




<!--
____________________________________________________

     More indepth description and use of the calc_wqi function
____________________________________________________

-->


# Water quality index calculation

The (CCME) WQI is used across Canada as a standardized approach to roll-up the status of multiple water quality parameters at a site and communicate the ‘state’ in a simple manner. The WQI focuses on water quality with respect to the health of freshwater aquatic health. The WQI approach is documented on the CCME website, including detailed methods, a list of established national parameter guidelines/thresholds, and a point and click MS Excel Calculator (http://www.ccme.ca/en/resources/canadian_environmental_quality_guidelines/index.html). The number of parameters with exceedances, the number of exceedances and the magnitude of exceedances (from (1), above) are used to generate a score (0 to 100) which is then converted to a ranking of quality (poor, marginal, fair, good, and excellent).





<!--
____________________________________________________

     More indepth use of the plot functions
____________________________________________________

-->


# Visual display of indices





<!--
____________________________________________________

     Pull in analys tools from other wq packages
____________________________________________________

-->


# Advanced examples









<!--

## the wq package for analysing trends in water chemistry

The standard approach for trend analysis on water quality time-series data is the Mann-Kendall Trend Test with methods to accommodate for autocorrelation. 


% some text that could come in useful... 

# Data

There is also two other lookup tables

* [codes] which provides the link between the code used to define type of water quality measurement and the full name (e.g. Aluminium Dissolved or pH).  The table also provides the units used for measurement and the type of summary measure used to summarise more than one value (i.e. the mean, the median or the geometric mean).

* [limits] which provides the link between the type of measurement (e.g. Aluminium Dissolved or pH) and the agreed water quality limmits for Brittish Columbia and Canada.  The table contains the upper and lower limits (where defined), the time scale at which the limit is defined (i.e. Month or Day) and any conditions on when the limits apply, for example there are different limits for dissolved aluminium depending on the whether the pH is above or below 6.5.


### Water Quality Thresholds

The exceedance analysis entails determining the appropriate parameter guideline threshold values for a given time-series dataset (e.g. data for set of parameters for each station/site) and then comparing the time-series data against the established guideline thresholds for each parameter. Guideline thresholds are established provincially by the BC Ministry of Environment (http://www2.gov.bc.ca/gov/topic.page?id=044DD64C7E24415D83D07430964113C9) and nationally by the Canadian Council of Ministers of the Environment (CCME; http://www.ccme.ca/en/resources/canadian_environmental_quality_guidelines/index.html). Provincial guidelines are used if there are (differing) guideline thresholds for a parameter.


### Analysing Trends in Water Chemistry

The standard approach for trend analysis on water quality time-series data is the Mann-Kendall Trend Test with methods to accommodate for autocorrelation. The outputs of the trend analysis include: summary results table for parameter trends by site, facet graphs of parameters with trend lines (e.g. data, trend line visible), and, a British Columbia map with colour-coded points denoting water quality trends (e.g. colour 1: one or more parameter significantly deteriorating; colour 2: all parameters stable; colour 3: one or more parameter significantly improving; colour 4: mixed significant results).


-->

